<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Koncat/Module.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- |</span>
<a name="line-3"></a><span class='hs-comment'>-- Module      : Koncat.Module</span>
<a name="line-4"></a><span class='hs-comment'>-- License     : WTFPL Version 2</span>
<a name="line-5"></a><span class='hs-comment'>-- Maintainer  : grab@thereisnobreak.net</span>
<a name="line-6"></a><span class='hs-comment'>-- Stability   : Unstable</span>
<a name="line-7"></a><span class='hs-comment'>-- Portability : Linux</span>
<a name="line-8"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><span class='hs-comment'>-- @Koncat.Module@ is responsible for starting and stopping Modules, checking if the</span>
<a name="line-10"></a><span class='hs-comment'>-- Module isn't annoying the IRC Server (for example flooding it, which could also lead into the server killing our bot)</span>
<a name="line-11"></a><span class='hs-comment'>-- and providing the Modules with the Koncat API</span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables, OverloadedStrings #-}</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Koncat</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span> <span class='hs-layout'>(</span>
<a name="line-18"></a>    <span class='hs-varid'>execMod</span>
<a name="line-19"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>constructModuleCall</span>  
<a name="line-20"></a><span class='hs-comment'>--  , readMod  </span>
<a name="line-21"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-22"></a>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Koncat</span><span class='hs-varop'>.</span><span class='hs-conid'>Source</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Koncat</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Koncat</span><span class='hs-varop'>.</span><span class='hs-conid'>Parsers</span><span class='hs-layout'>(</span><span class='hs-varid'>getTime</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Process</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Posix</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Posix</span><span class='hs-varop'>.</span><span class='hs-conid'>Terminal</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Timeout</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Koncat</span><span class='hs-varop'>.</span><span class='hs-conid'>Core</span><span class='hs-varop'>.</span><span class='hs-conid'>API</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>Printf</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span><span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span><span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>Socket</span> <span class='hs-layout'>(</span><span class='hs-conid'>Socket</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>Char8</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>B</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>catch</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="execMod"></a><span class='hs-comment'>-- | Execute a Module, streaming its output into IRC.</span>
<a name="line-44"></a><span class='hs-definition'>execMod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IRC</span> <span class='hs-conid'>()</span>
<a name="line-45"></a><span class='hs-definition'>execMod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-46"></a>    <span class='hs-varid'>sock</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>iSock</span>
<a name="line-47"></a>    <span class='hs-varid'>counter</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>modCnt</span>
<a name="line-48"></a>    
<a name="line-49"></a>    <span class='hs-comment'>-- Increments the counter the State is carrying</span>
<a name="line-50"></a>    <span class='hs-comment'>-- for future modules to be called.</span>
<a name="line-51"></a>    <span class='hs-varid'>incCounter</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-comment'>-- Start the Module</span>
<a name="line-54"></a>    <span class='hs-varid'>io</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>forkIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>initModule</span> <span class='hs-varid'>counter</span> <span class='hs-varid'>appl</span> <span class='hs-varid'>sock</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-comment'>-- Change the destination of the ModuleCall if the -to flag</span>
<a name="line-57"></a>    <span class='hs-comment'>-- has been toggled</span>
<a name="line-58"></a>    <span class='hs-varid'>appl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>applyModuleFlags</span> <span class='hs-varid'>m</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="initModule"></a><span class='hs-definition'>initModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-61"></a><span class='hs-definition'>initModule</span> <span class='hs-varid'>counter</span> <span class='hs-varid'>m</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-62"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>debug</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putStrLn</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Starting Module: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>m</span>
<a name="line-63"></a>
<a name="line-64"></a>    <span class='hs-comment'>-- Using a Pseudoterminal is neccessary because Modules are likely</span>
<a name="line-65"></a>    <span class='hs-comment'>-- not to flush stdout regularily. This would result in the data</span>
<a name="line-66"></a>    <span class='hs-comment'>-- the module sends not being available until execution stops.</span>
<a name="line-67"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>master</span><span class='hs-layout'>,</span> <span class='hs-varid'>slave</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openPseudoTerminal</span>
<a name="line-68"></a>    <span class='hs-varid'>hSlave</span>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fdToHandle</span> <span class='hs-varid'>slave</span>
<a name="line-69"></a>    <span class='hs-varid'>hMaster</span>         <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fdToHandle</span> <span class='hs-varid'>master</span>
<a name="line-70"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>pid</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>&lt;-</span> 
<a name="line-71"></a>        <span class='hs-varid'>createProcess</span> <span class='hs-layout'>(</span><span class='hs-varid'>proc</span> <span class='hs-layout'>(</span><span class='hs-varid'>path</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-varid'>std_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UseHandle</span> <span class='hs-varid'>hSlave</span> 
<a name="line-72"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>std_in</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UseHandle</span> <span class='hs-varid'>hSlave</span>
<a name="line-73"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>std_err</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UseHandle</span> <span class='hs-varid'>hSlave</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>
<a name="line-75"></a>    <span class='hs-comment'>-- Put the Function name in the Modules stdin                                     </span>
<a name="line-76"></a>    <span class='hs-varid'>hPutStrLn</span> <span class='hs-varid'>hMaster</span> <span class='hs-varop'>$</span> <span class='hs-varid'>func</span> <span class='hs-varid'>m</span>
<a name="line-77"></a>
<a name="line-78"></a>    <span class='hs-comment'>-- Next, put the Args in the Modules stdin, separated by a space.</span>
<a name="line-79"></a>    <span class='hs-comment'>-- Note that because of this it is not possible for Modules to receive</span>
<a name="line-80"></a>    <span class='hs-comment'>-- args that contain spaces in them.</span>
<a name="line-81"></a>    <span class='hs-varid'>hPutStrLn</span> <span class='hs-varid'>hMaster</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unwords</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>""</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-82"></a>
<a name="line-83"></a>    <span class='hs-comment'>-- Throw away 2 Lines from the Modules stdout.</span>
<a name="line-84"></a>    <span class='hs-comment'>-- This is neccessary because otherwise the two lines we put in the modules</span>
<a name="line-85"></a>    <span class='hs-comment'>-- stdin previously would be sent to IRC. We don't want that</span>
<a name="line-86"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetLine</span> <span class='hs-varid'>hMaster</span>
<a name="line-87"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetLine</span> <span class='hs-varid'>hMaster</span>
<a name="line-88"></a>
<a name="line-89"></a>    <span class='hs-comment'>-- React accordingly if the -maxexec flag is set. Otherwise retrieve</span>
<a name="line-90"></a>    <span class='hs-comment'>-- the Modules Maximum Execution time from the SQL Database.</span>
<a name="line-91"></a>    <span class='hs-varid'>maxExec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decideMaxExec</span> <span class='hs-layout'>(</span><span class='hs-varid'>getFlag</span> <span class='hs-str'>"maxexec"</span> <span class='hs-layout'>(</span><span class='hs-varid'>flags</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-92"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-num'>4</span> <span class='hs-varop'>$</span> <span class='hs-varid'>path</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>func</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-93"></a>
<a name="line-94"></a>    <span class='hs-comment'>-- Enter the loop, wrapping the computation in the timeout function.</span>
<a name="line-95"></a>    <span class='hs-comment'>-- Note that we are currently not in the IRC Monad, so all the sockets</span>
<a name="line-96"></a>    <span class='hs-comment'>-- have to be carried over manually.</span>
<a name="line-97"></a>    <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>timeout</span> <span class='hs-varid'>maxExec</span> <span class='hs-varop'>$</span> <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasFlag</span> <span class='hs-str'>"nocnt"</span>     <span class='hs-varop'>$</span> <span class='hs-varid'>flags</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> 
<a name="line-98"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>hasFlag</span> <span class='hs-str'>"nomodstop"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>flags</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> 
<a name="line-99"></a>                                <span class='hs-varid'>counter</span> <span class='hs-varid'>hMaster</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-varid'>dest</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-100"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>of</span>
<a name="line-101"></a>
<a name="line-102"></a>        <span class='hs-comment'>-- The Module has exceeded the Maximum Execution time.</span>
<a name="line-103"></a>        <span class='hs-comment'>-- Unless the -nokill flag is set, send an Error Message to IRC</span>
<a name="line-104"></a>        <span class='hs-comment'>-- and kill the process.</span>
<a name="line-105"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-106"></a>            <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasFlag</span> <span class='hs-str'>"nokill"</span> <span class='hs-layout'>(</span><span class='hs-varid'>flags</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span><span class='hs-varid'>privmsg'</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-varid'>dest</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> 
<a name="line-107"></a>                <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varop'>$</span> <span class='hs-varid'>printf</span> <span class='hs-str'>"Module violating Maximum Execution time of %d : %s"</span> <span class='hs-varid'>maxExec</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-108"></a>                <span class='hs-varid'>terminateProcess</span> <span class='hs-varid'>pid</span><span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a>        <span class='hs-comment'>-- Do nothing if everything went fine.      </span>
<a name="line-111"></a>        <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>   
<a name="line-112"></a>
<a name="line-113"></a><a name="fetchLine"></a><span class='hs-definition'>fetchLine</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span>
<a name="line-114"></a><span class='hs-definition'>fetchLine</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>catch</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>IOException</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-115"></a>        <span class='hs-comment'>-- GHC thinks a Hardware fault occured when the Process</span>
<a name="line-116"></a>        <span class='hs-comment'>-- inside the Pseudoterminal ends. Let's catch it and</span>
<a name="line-117"></a>        <span class='hs-comment'>-- tell loop that there are no more lines coming.</span>
<a name="line-118"></a>        <span class='hs-comment'>-- Note that the "EOI" message can be spoofed by a module</span>
<a name="line-119"></a>        <span class='hs-comment'>-- and thus tricking loop into thinking that Module execution stopped.</span>
<a name="line-120"></a>        <span class='hs-comment'>-- I don't know how this would be a vulnerability but it will</span>
<a name="line-121"></a>        <span class='hs-comment'>-- be fixed in the future.</span>
<a name="line-122"></a>        <span class='hs-varid'>return</span> <span class='hs-str'>"EOI"</span>
<a name="line-123"></a>    <span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>hGetLine</span> <span class='hs-varid'>h</span>
<a name="line-124"></a>
<a name="line-125"></a><a name="loop"></a><span class='hs-definition'>loop</span> <span class='hs-keyglyph'>::</span> 
<a name="line-126"></a>     <span class='hs-comment'>-- Indicator that the -nocnt switch has been flipped,</span>
<a name="line-127"></a>     <span class='hs-comment'>-- thus resulting in the Bot not writing the Counter </span>
<a name="line-128"></a>     <span class='hs-comment'>-- in front of every Message.</span>
<a name="line-129"></a>        <span class='hs-conid'>Bool</span> 
<a name="line-130"></a>
<a name="line-131"></a>     <span class='hs-comment'>-- Indicator that the -nostop switch has been flipped. </span>
<a name="line-132"></a>     <span class='hs-comment'>-- This results in the Bot not sending a "Module stopped" message </span>
<a name="line-133"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> 
<a name="line-134"></a>
<a name="line-135"></a>     <span class='hs-comment'>-- The Counter which is displayed in front of every message</span>
<a name="line-136"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span> 
<a name="line-137"></a>
<a name="line-138"></a>     <span class='hs-comment'>-- The stdout of the Module</span>
<a name="line-139"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> 
<a name="line-140"></a>
<a name="line-141"></a>     <span class='hs-comment'>-- The IRC Network Socket</span>
<a name="line-142"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span>
<a name="line-143"></a>
<a name="line-144"></a>     <span class='hs-comment'>-- The Channel/Nick we should send the response to.</span>
<a name="line-145"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Channel</span> 
<a name="line-146"></a>
<a name="line-147"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-148"></a><span class='hs-definition'>loop</span> <span class='hs-varid'>nocnt</span> <span class='hs-varid'>nostop</span> <span class='hs-varid'>counter</span> <span class='hs-varid'>h</span> <span class='hs-varid'>ircH</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-149"></a>    <span class='hs-varid'>line</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fetchLine</span> <span class='hs-varid'>h</span>
<a name="line-150"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>line</span> <span class='hs-keyword'>of</span> 
<a name="line-151"></a>        <span class='hs-str'>"EOI"</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>nostop</span> <span class='hs-varop'>$</span> <span class='hs-varid'>privmsg'</span> <span class='hs-varid'>ircH</span> <span class='hs-varid'>c</span> <span class='hs-layout'>(</span><span class='hs-varid'>sqBW</span>  <span class='hs-varop'>`</span><span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>append</span><span class='hs-varop'>`</span> <span class='hs-str'>"Module Stopped."</span> <span class='hs-layout'>)</span>
<a name="line-152"></a>        <span class='hs-varid'>a</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>privmsg'</span> <span class='hs-varid'>ircH</span> <span class='hs-varid'>c</span> <span class='hs-layout'>(</span><span class='hs-varid'>sqBW</span> <span class='hs-varop'>`</span><span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>append</span><span class='hs-varop'>`</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>nocnt</span> <span class='hs-varid'>nostop</span> <span class='hs-varid'>counter</span> <span class='hs-varid'>h</span> <span class='hs-varid'>ircH</span> <span class='hs-varid'>c</span>
<a name="line-153"></a>  <span class='hs-keyword'>where</span>
<a name="line-154"></a>    <span class='hs-varid'>sqBW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span>
<a name="line-155"></a>    <span class='hs-varid'>sqBW</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>nocnt</span> <span class='hs-keyword'>then</span>
<a name="line-156"></a>               <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-157"></a>           <span class='hs-keyword'>else</span> <span class='hs-str'>"["</span> <span class='hs-varop'>`</span><span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>append</span><span class='hs-varop'>`</span> <span class='hs-layout'>(</span><span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varop'>$</span> <span class='hs-varid'>show</span> <span class='hs-varid'>counter</span><span class='hs-layout'>)</span> <span class='hs-varop'>`</span><span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>append</span><span class='hs-varop'>`</span> <span class='hs-str'>"] "</span>
<a name="line-158"></a>
<a name="line-159"></a><a name="applyModuleFlags"></a><span class='hs-definition'>applyModuleFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleCall</span>
<a name="line-160"></a><span class='hs-definition'>applyModuleFlags</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getFlag</span> <span class='hs-str'>"to"</span> <span class='hs-layout'>(</span><span class='hs-varid'>flags</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-161"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span>
<a name="line-162"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>a</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>{</span><span class='hs-varid'>dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="decideMaxExec"></a><span class='hs-definition'>decideMaxExec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span>     
<a name="line-165"></a><span class='hs-definition'>decideMaxExec</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>mPath</span> <span class='hs-varid'>mFunc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flag</span> <span class='hs-keyword'>of</span>
<a name="line-166"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getMaxExecTime</span> <span class='hs-varid'>mPath</span> <span class='hs-varid'>mFunc</span>
<a name="line-167"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>a</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getTime</span> <span class='hs-varop'>$</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>a</span> 
<a name="line-168"></a>
<a name="line-169"></a><span class='hs-comment'>--checkUserPrivileges :: IRCCommand -&gt; IO Bool    </span>
<a name="line-170"></a><span class='hs-comment'>--checkUserPrivileges i = case </span>
<a name="line-171"></a>
<a name="line-172"></a><a name="constructModuleCall"></a><span class='hs-comment'>-- | Collect Information neccessary to start a Module.</span>
<a name="line-173"></a><span class='hs-definition'>constructModuleCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericIRC</span><span class='hs-layout'>,</span> <span class='hs-conid'>IRCCommand</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Information about the user, information about the command the user issued</span>
<a name="line-174"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>                  <span class='hs-comment'>-- ^ the modulePath, as retrieved via Koncat.Source.expose</span>
<a name="line-175"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleCall</span>
<a name="line-176"></a><span class='hs-definition'>constructModuleCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>mPath</span> <span class='hs-keyglyph'>=</span> 
<a name="line-177"></a>    <span class='hs-conid'>ModuleCall</span> <span class='hs-layout'>{</span> <span class='hs-varid'>path</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mPath</span>
<a name="line-178"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>func</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qFunc</span> <span class='hs-varid'>b</span>
<a name="line-179"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>args</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qArgs</span> <span class='hs-varid'>b</span>
<a name="line-180"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>dest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>a</span>
<a name="line-181"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>flags</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qFlags</span> <span class='hs-varid'>b</span>
<a name="line-182"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>caller</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>user</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre></body>
</html>
